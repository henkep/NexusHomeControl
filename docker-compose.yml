services:
  nginx:
    image: nginx:alpine
    container_name: nexus-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nexus.conf:/etc/nginx/conf.d/default.conf:ro
      - ./dashboard:/var/www/nexus:ro
      - ./setup-wizard:/var/www/setup:ro
      - ./ssl:/etc/ssl:ro
    depends_on:
      - api
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - nexus

  api:
    build: ./api
    container_name: nexus-api
    # Use host network so API can scan local network and reach PiAware
    network_mode: "host"
    environment:
      - CONFIG_PATH=/opt/nexus/config.json
      - CREDENTIALS_PATH=/opt/nexus/.credentials.json
      - TCC_USERNAME=${TCC_USERNAME:-}
      - TCC_PASSWORD=${TCC_PASSWORD:-}
      - RING_REFRESH_TOKEN=${RING_REFRESH_TOKEN:-}
      - SHELLY_AUTH_KEY=${SHELLY_AUTH_KEY:-}
      - PORT=3000
    volumes:
      - ./data:/opt/nexus
      - ./setup-wizard:/app/setup-wizard:ro
      # Mount entire project for self-update capability
      - .:/opt/nexus-project
      # Mount Docker socket for self-rebuild capability
      - /var/run/docker.sock:/var/run/docker.sock
      # If PiAware runs on THIS Pi, uncomment to use local file:
      # - /run/dump1090-fa:/run/dump1090-fa:ro
    restart: unless-stopped

  redis:
    image: redis:alpine
    container_name: nexus-redis
    volumes:
      - ./data/redis:/data
    restart: unless-stopped
    networks:
      - nexus

  # Uncomment to enable Cloudflare Tunnel
  # cloudflared:
  #   image: cloudflare/cloudflared:latest
  #   container_name: nexus-tunnel
  #   command: tunnel run
  #   volumes:
  #     - ./cloudflared:/etc/cloudflared
  #   restart: unless-stopped
  #   networks:
  #     - nexus

  # PiAware / ADS-B Flight Tracking (optional)
  # Requires RTL-SDR USB dongle and FlightAware account
  # To enable: docker compose --profile piaware up -d
  piaware:
    image: ghcr.io/sdr-enthusiasts/docker-piaware:latest
    container_name: nexus-piaware
    profiles:
      - piaware
    env_file:
      - .env.piaware
    environment:
      - TZ=${TZ:-America/New_York}
      - FEEDER_ID=${PIAWARE_FEEDER_ID:-}
      - FEEDER_LAT=${PIAWARE_LAT:-}
      - FEEDER_LON=${PIAWARE_LON:-}
      - FEEDER_NAME=${PIAWARE_NAME:-NEXUS-Home}
      - BEASTHOST=
      - RECEIVER_TYPE=rtlsdr
    devices:
      - /dev/bus/usb:/dev/bus/usb
    ports:
      - "8080:8080"    # SkyAware web interface
      - "30003:30003"  # Raw data
      - "30005:30005"  # Beast data
    volumes:
      - piaware-data:/var/cache/piaware
    tmpfs:
      - /run:exec,size=64M
      - /var/log
    restart: unless-stopped
    networks:
      - nexus

volumes:
  piaware-data:

networks:
  nexus:
    driver: bridge
